<html>

  <!--
    Congle Zhang and Conrad Nied's (The Cons) CSE512 Assignment 3
    Designed 2014-01-29
  -->

  <head>
    <title> CSE512 Assignment 3</title>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>

    <script language="JavaScript" type="text/javascript">
      var dataset;
      var tooltip;

      window.onload = function () {
        // Load the SVG
        d3.xml("LanguageMap.svg", "image/svg+xml", function(xml) {
          document.body.appendChild(xml.documentElement);

          // Set the tooltip
          tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "hidden")
            .style("background-color", "#ffffff")
            .style("border-radius", "5")
            .style("padding", "2")
            .text("");

          // Load the data
          txt = d3.text("LanguageLineages3.csv", function(datasetText) {
            dataset = d3.csv.parseRows(datasetText);

            initializeCountries();
            setCountryClasses();
            drawTable();
          });
        });
      }


      function initializeCountries() {
        // Set the language java events
        countries = d3.select("body").select("svg").selectAll("path")
          .style({stroke:'2'})
          .on('mouseover', function(d){
            country = d3.select(this);
            tooltip.style("visibility", "visible")
              .text(country.attr("title")); 
            d3.selectAll("." + country.attr("title"))
              .style("opacity", "0.8"); 
          })
          .on("mousemove", function(d){
            tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
          })
          .on('mouseout', function(d){
            country = d3.select(this);
            tooltip.style("visibility", "hidden");
            d3.selectAll("." + country.attr("title"))
              .style("opacity", "1"); 
          });
        circles = d3.select("body").select("svg").selectAll("circle")
          .style({stroke:'2'})
          .on('mouseover', function(d){
            country = d3.select(this);
            tooltip.style("visibility", "visible")
              .text(country.attr("title")); 
            d3.selectAll("." + country.attr("title"))
              .style("opacity", "0.8"); 
          })
          .on("mousemove", function(d){
            tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
          })
          .on('mouseout', function(d){
            country = d3.select(this);
            tooltip.style("visibility", "hidden");
            d3.selectAll("." + country.attr("title"))
              .style("opacity", "1"); 
          });
      } 

      function setCountryClasses() {

        // Set country titles
        for(var i = 1; i < dataset.length; i++) {
          var countryname = dataset[i][0];
          var country = d3.selectAll("." + countryname)
            .attr("title", countryname)
            .attr("class", dataset[i][9])
            .style("fill", str2rgb(countryname));

          country.selectAll("path")
              .attr("title", countryname);
          country.selectAll("circle")
              .attr("title", countryname);
        }
      }

      function drawTable() {
        d3.select("body").append("table")
          .style("border-collapse", "collapse")
          .style("border", "2px black solid")
          
          .selectAll("tr")
          .data(dataset)
          .enter().append("tr")
          
          .selectAll("td")
          .data(function(d){return d;})
          .enter().append("td")
          .style("border", "1px black solid")
          .style("padding", "10px")
          .style("background-color", function(d) {
            return str2rgb(d);
          })
          .on("mouseover", function(){
            color = d3.select(this).style("background-color");
            d3.select(this).style("opacity", "0.8")
            txt = d3.select(this).text();
            d3.selectAll("." + txt).style("opacity", "0.8");
            //d3.selectAll("." + txt).style("fill", color);
          }) 
          .on("mouseout", function(){
            d3.select(this).style("opacity", "1")
            txt = d3.select(this).text();
            d3.selectAll("." + txt).style("opacity", "1");
          }) 
          .on("click", function(){
            color = d3.select(this).style("background-color");
            txt = d3.select(this).text();
            d3.selectAll("." + txt).style("fill", color);
            console.log("." + txt);
          }) 
          .text(function(d){return d;})
          .style("font-size", "12px");

      }

      str2rgb = function(s) {
        hash = hashCode(s);
        r = (hash & 0xFF0000) >> 16;
        g = (hash & 0x00FF00) >> 8;
        b = hash & 0x0000FF;
        return "rgb(" + r + ", " + g + ", " + b + ")";
      }

      hashCode = function(s){
       return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);              
      }
    </script>
  </head>

  <body>
  </body>
</html>